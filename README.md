# lua-utf8-identifiers

This is a patch of Lua that allows you to turn on UTF-8 identifiers by defining `ALLOW_UTF8_IDENTIFIERS` at compile time. This allows fun identifiers like `π = math.pi` or `φ = (1 + math.sqrt(5)) / 2`. It involves modifications to lctype.c, lctype.h, and llex.c.

This is done in the following way. When parsing identifiers, The lexer treats the bytes 0x80-0xFF as alphabetic and saves them in a buffer like the usual Lua identifier characters (`"[%a_][%w_]+"`). This is what an [existing approach](http://lua-users.org/wiki/UnicodeIdentifers) to allowing "Unicode identifiers" involves, but without any further steps, you can have crazy things like whitespace identifiers (not to mention invalid UTF-8)!

To prevent things like that, if the buffer contains non-ASCII bytes, the lexer then validates the potential identifier, using a function that steps through it, decoding byte sequences into code points and checking that the code points are allowed in an identifier.

The code points are compared to two arrays of ranges of code point. One array contains code points with the XID_Start property, which are allowed at the beginning of an identifier (like ASCII alphabetic characters and underscore in vanilla Lua); the other contains code points with the XID_Continue property, which include XID_Start code points as well as code points that can only appear after the first code point (like ASCII digits in vanilla Lua). Thus some code points appear in both arrays and the second array is longer.

If an identifier is not valid UTF-8 or contains a code point that is not allowed, an error is thrown at compile time. This is the only place in the source code where encoding is checked at compile time; as in vanilla Lua, strings and comments can still contain arbitrary bytes, including invalid UTF-8.

The validation functions are found in a custom header. They use data that is generated by a Lua script from [DerivedCoreProperties.txt](https://www.unicode.org/Public/UNIDATA/DerivedCoreProperties.txt). The current version is based on Unicode 11.0.
